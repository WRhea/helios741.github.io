(function(window){var box=document.getElementsByClassName("box")[0],gesPWD=document.getElementById("gesPWD"),item=gesPWD.getElementsByTagName("span"),msg=document.getElementById("msg"),aboutPWD=document.getElementById("aboutPWD"),canvas=document.getElementById("canvas"),pwdBtn=aboutPWD.getElementsByTagName("span"),radio=aboutPWD.getElementsByTagName("input"),radioLen=radio.length,itemLen=item.length,gesPWDWidth=gesPWD.offsetWidth,gesPWDHeight=gesPWD.offsetHeight,cobj=canvas.getContext("2d"),touchTot=0,prePWD="",eventArr=["Class","event","line","storage"];var defaultItemWidth=30,defaultItemHeight=30,defaultLineSize=2,defaultPointSum=5,defaultCanvasW=window.innerWidth,defaultCanvasH=300,defaultLineColor="rgb(224,43,27)";function createScript(name){var script=document.createElement("script");script.type="text/javascript";script.src="./src/js/"+name+".js";document.body.appendChild(script);return script}function renderItem(w,h){for(var i=0;i<itemLen;i++){item[i].style.width=w+"px";item[i].style.height=h+"px"}}function setCfg(cfg){cfg=cfg||{};cfg.canvasW=canvas.width=cfg.canvasW?cfg.canvasW:defaultCanvasW;cfg.canvasH=canvas.height=cfg.canvasH?cfg.canvasH:defaultCanvasH;cfg.itemW=cfg.itemW?cfg.itemW:defaultItemWidth;cfg.itemH=cfg.itemH?cfg.itemH:defaultItemHeight;cfg.lineSize=cfg.lineSize?cfg.lineSize:defaultLineSize;cfg.lineColor=cfg.lineColor?cfg.lineColor:defaultLineColor;cfg.minPointSum=cfg.minPointSum?cfg.minPointSum:defaultPointSum;cfg.titleTop=canvas.offsetTop;return cfg}function unloakUI(cfg){this.line={};cfg=setCfg(cfg);unloakUI.prototype.cfg=cfg;renderItem(cfg.itemW,cfg.itemH);unloakUI.prototype.init(pwdBtn[0])}unloakUI.fn=unloakUI.prototype;unloakUI.prototype.addUIEvent=function(){var line=new this.Line(item,cobj),me=this;this.line=line;this.Event.addEvent(aboutPWD,this.checkOpt.bind(me),"touchstart");this.Event.addEvent(aboutPWD,this.checkOpt.bind(me),"click");this.Event.addEvent(canvas,line.touchStart.bind(line),"touchstart");this.Event.addEvent(canvas,line.touchStart.bind(line),"mousedown");this.Event.addEvent(canvas,line.touchMove.bind(line),"touchmove");this.Event.addEvent(canvas,line.touchMove.bind(line),"mousemove");this.Event.addEvent(canvas,line.touchEnd.bind(line),"touchend");this.Event.addEvent(canvas,line.touchEnd.bind(line),"mouseup");this.Event.addEvent(canvas,this.saveOrCheck.bind(me),"touchend");this.Event.addEvent(canvas,this.saveOrCheck.bind(me),"mouseup")};unloakUI.prototype.init=function(item){if(this.cfg.compress||(this.line&&this.storage&&this.event&&this.Class)){me.Class.addClass(item,"active");return}var me=this;(function iterator(i){if(i>=eventArr.length){me.Class.addClass(item,"active");me.addUIEvent();return}var script=createScript(eventArr[i]);script.onload=function(){iterator(i+1)}})(0)};unloakUI.prototype.clearClass=function(){this.Class.removeClass(msg,"warning");this.Class.removeClass(msg,"info");this.Class.removeClass(msg,"error");this.Class.removeClass(msg,"success")};unloakUI.prototype.checkOpt=function(event){var target=this.Event.getTarget(event);this.clearClass();if(target.nodeName.toLowerCase()!=="label"){return}var input=target.getElementsByTagName("input")[0];if(input["id"]==="set-pwd"){this.Class.addClass(pwdBtn[0],"active");this.Class.removeClass(pwdBtn[1],"active");msg.innerHTML="请设置密码"}else{this.Class.addClass(pwdBtn[1],"active");this.Class.removeClass(pwdBtn[0],"active");msg.innerHTML="请输入您的密码"}};unloakUI.prototype.errLine=function(errpwd){var len=errpwd.length;var me=this;for(var i=0;i<len;i++){me.Class.addClass(item[errpwd[i]]," error ")}(function iterator(i){if(i===len){return}setTimeout(function(){me.Class.removeClass(item[errpwd[i]]," error ");iterator(i+1)},500*(!i?1:0))})(0)};unloakUI.prototype.saveOrCheck=function(){var me=this,PWD=this.line.getPWD(),tmpPWD=PWD.join(",");if (!tmpPWD) return ;me.clearClass();if(radio[0]["checked"]){touchTot++;if(touchTot==1){if(PWD.length<this.cfg.minPointSum){touchTot=0;msg.innerHTML="密码至少"+this.cfg.minPointSum+"个点";me.Class.addClass(msg,"warning");return}msg.innerHTML="请确认密码";me.Class.addClass(msg,"info");if(!me.Storage.support){alert("您的浏览器不支持localstorage！");return}prePWD=tmpPWD;return}if(tmpPWD===prePWD){msg.innerHTML="密码设置成功";me.Class.addClass(msg,"success");me.Storage.savePWD(PWD)}else{msg.innerHTML="密码不一样，请重新输入密码";me.Class.addClass(msg,"error")}touchTot=0}else{if(tmpPWD===me.Storage.getPWD()){msg.innerHTML="验证成功，可重复尝试";me.Class.addClass(msg,"success")}else{msg.innerHTML="验证失败";me.errLine(tmpPWD.split(","));me.Class.addClass(msg," error ")}}};window.unloakUI=unloakUI;if(box.getAttribute("data-unloack")!==null){new unloakUI()}})(window);(function(unloakUI){var Class={hasClass:function(elem,CN){return !!elem.className.match(new RegExp("(\\s|^)"+CN.trim()+"(\\s|$)"))},addClass:function(elem,CN){if(!this.hasClass(elem,CN)){elem.className+=" "+CN.trim()}},removeClass:function(elem,CN){if(this.hasClass(elem,CN.trim())){var reg=new RegExp("(\\s|^)"+CN.trim()+"(\\s|$)");elem.className=elem.className.replace(reg," ").trim()+" "}}};unloakUI.Class=Class})(unloakUI.fn);(function(unloakUI){var event={addEvent:function(elem,handler,type){if(elem.addEventListener){elem.addEventListener(type,handler,false)}else{elem.attachEvent("on"+type,function(){handler.call(elem)})}},preventDefault:function(ev){if(ev.preventDefault){ev.preventDefault()}else{ev.returnValue=true}},getTarget:function(ev){return ev.target||ev.srcElement}};unloakUI.Event=event})(unloakUI.fn);(function(unloakUI){var _map=new Array(),_clickOne=false,_tar,_start,PWD=new Array(),_tmpMap=new Array(),_visMap=new Array();function _initMap(){for(var i=0;i<10;i++){_map[i]=new Array();_tmpMap[i]=new Array();for(var j=0;j<10;j++){_map[i][j]=false;_tmpMap[i][j]=false}}}function _initTmpMap(){for(var i=0;i<10;i++){_tmpMap[i]=new Array();for(var j=0;j<10;j++){_tmpMap[i][j]=false}}}function _initVisMap(){for(var i=0;i<10;i++){_visMap[i]=false}}_initMap();function line(item,cobj){var itemArr=[];item=item||[];for(var i=0;i<item.length;i++){itemArr.push({left:item[i].offsetLeft,top:item[i].offsetTop})}this.x=0;this.y=0;this.lineSize=unloakUI.cfg.lineSize;this.titleTop=unloakUI.cfg.titleTop;this.w=unloakUI.cfg.canvasW;this.h=unloakUI.cfg.canvasH;this.cobj=cobj;this.item=item;this.itemW=unloakUI.cfg.itemW;this.itemH=unloakUI.cfg.itemH;this.arr=itemArr;this.len=itemArr.length;this.isDone=true;this.color=unloakUI.cfg.lineColor}line.prototype={constructor:line,_DFSLine:function(st){for(var i=0;i<this.len;i++){if(!_map[st][i]||_visMap[i]){continue}_visMap[i]=true;PWD.push(i);var sx=this.arr[i].left+this.itemW/4+5,sy=this.arr[i].top+this.itemH/4;this.cobj.lineTo(sx,sy);this._DFSLine(i)}},_checkMidLine:function(){if(_tmpMap[0][6]){_map[0][6]=_map[0][6]=false;var flag=false;for(var i=0;i<this.len;i++){if(_map[3][i]){flag=true;break}}if(!flag){unloakUI.Class.addClass(this.item[3],"active");_map[0][3]=_map[3][0]=_map[3][6]=_map[6][3]=true}else{_map[0][6]=_map[0][6]=true}}if(_tmpMap[0][2]){_map[0][2]=_map[2][0]=false;var flag=false;for(var i=0;i<this.len;i++){if(_map[1][i]){flag=true;break}}if(!flag){unloakUI.Class.addClass(this.item[1],"active");_map[0][1]=_map[1][0]=_map[2][1]=_map[1][2]=true}else{_map[0][2]=_map[2][0]=true}}if(_tmpMap[1][7]){_map[1][7]=_map[7][1]=false;var flag=false;for(var i=0;i<this.len;i++){if(_map[4][i]){flag=true;break}}if(!flag){unloakUI.Class.addClass(this.item[4],"active");_map[1][4]=_map[4][1]=_map[4][7]=_map[7][4]=true}else{_map[1][7]=_map[7][1]=true}}if(_tmpMap[2][6]){_map[2][6]=_map[6][2]=false;var flag=false;var t;for(var i=0;i<this.len;i++){if(_map[4][i]){flag=true;break}}if(!flag){unloakUI.Class.addClass(this.item[4],"active");_map[2][4]=_map[4][2]=_map[4][6]=_map[6][4]=true}else{_map[2][6]=_map[6][2]=true}}if(_tmpMap[2][8]){_map[2][8]=_map[8][2]=false;var flag=false;for(var i=0;i<this.len;i++){if(_map[5][i]){flag=true;break}}if(!flag){unloakUI.Class.addClass(this.item[5],"active");_map[2][5]=_map[5][2]=_map[5][8]=_map[8][5]=true}else{_map[2][8]=_map[8][2]=true}}if(_tmpMap[0][8]){_map[0][8]=_map[8][0]=false;var flag=false;for(var i=0;i<this.len;i++){if(_map[4][i]){flag=true;break}}if(!flag){unloakUI.Class.addClass(this.item[4],"active");_map[0][4]=_map[4][0]=_map[4][8]=_map[8][4]=true}else{_map[0][8]=_map[8][0]=true}}if(_tmpMap[6][8]){_map[6][8]=_map[8][6]=false;var flag=false;for(var i=0;i<this.len;i++){if(_map[7][i]){flag=true;break}}if(!flag){unloakUI.Class.addClass(this.item[7],"active");_map[6][7]=_map[7][6]=_map[7][8]=_map[8][7]=true}else{_map[6][8]=_map[8][6]=true}}},renderAllLine:function(sze){this.cobj.beginPath();this.cobj.lineWidth=sze;_initVisMap();_visMap[_start]=true;var sx=this.arr[_start].left+this.itemW/4+5,sy=this.arr[_start].top+this.itemH/4;this.cobj.moveTo(sx,sy);this._DFSLine(_start);this.cobj.stroke()},renderOneLine:function(sx,sy,ex,ey,sze){this.cobj.beginPath();this.cobj.lineWidth=sze;this.cobj.strokeStyle=this.color;this.cobj.moveTo(sx,sy);this.cobj.lineTo(ex,ey);this.cobj.stroke()},touchStart:function(e){e.preventDefault();var touch=e.touches?e.touches[0]:{},x=touch.clientX||e.clientX,y=touch.clientY||e.clientY;y-=this.titleTop;for(var i=0;i<this.len;i++){if(x<this.arr[i].left||x>this.arr[i].left+this.itemW){continue}else{if(y<this.arr[i].top||y>this.arr[i].top+this.itemH){continue}}unloakUI.Class.addClass(this.item[i],"active");this.x=this.arr[i].left+this.itemW/4+5;this.y=this.arr[i].top+this.itemH/4;this.isDone=false;_clickOne=true;_tar=i;_start=i;_initMap()}},touchMove:function(e){if(this.isDone){return}e.preventDefault();var touch=touch=e.touches?e.touches[0]:{},nx=touch.clientX||e.clientX,ny=(touch.clientY||e.clientY)-this.titleTop;if(_clickOne){for(var i=0;i<this.len;i++){if(nx<this.arr[i].left||nx>this.arr[i].left+this.itemW){continue}else{if(ny<this.arr[i].top||ny>this.arr[i].top+this.itemH){continue}else{if(unloakUI.Class.hasClass(this.item[i],"active")){continue}}}nx=this.arr[i].left+this.itemW/4+5;ny=this.arr[i].top+this.itemH/4;unloakUI.Class.addClass(this.item[i]," active");this.renderOneLine(this.x,this.y,nx,ny);this.x=nx;this.y=ny;_map[_tar][i]=true;_map[i][_tar]=true;_tmpMap[_tar][i]=true;_tmpMap[i][_tar]=true;this._checkMidLine();_initTmpMap();_tar=i}}this.cobj.clearRect(0,0,this.w,this.h);this.renderAllLine(this.lineSize);this.renderOneLine(this.x,this.y,nx,ny,this.lineSize)},touchEnd:function(e){this.isDone=true;e.preventDefault();_clickOne=false;_initVisMap();PWD=[_start];_visMap[_start]=true;this._DFSLine(_start);_initMap();this.cobj.stroke();this.cobj.closePath();this.cobj.clearRect(0,0,this.w,this.h);for(var i=0;i<this.len;i++){unloakUI.Class.removeClass(this.item[i],"active")}},getPWD:function(){return PWD}};unloakUI.Line=line})(unloakUI.fn);(function(unloakUI,window){unloakUI.Storage={_prefix:"360_",support:!!window.localStorage,savePWD:function(pwd){var storage=window.localStorage;storage.setItem(this._prefix+"pwd",pwd)},getPWD:function(){var storage=window.localStorage;return storage.getItem(this._prefix+"pwd")},removePWD:function(){return storage.removeItem("pwd")}}})(unloakUI.fn,window);